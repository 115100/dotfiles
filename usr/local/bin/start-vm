#!/usr/bin/env python
# vim: set syntax=python:
import os
import subprocess

ARGS = [
    'qemu-system-x86_64',
    '-serial', 'none',
    '-parallel', 'none',
    '-enable-kvm',
    '-name', 'Windows',
    '-bios', '/usr/share/edk2-ovmf/OVMF.fd',
    '-m', '16384',
    '-net', 'nic',
    '-net', 'user,smb=/home/user/Desktop/Files/a',
    '-mem-prealloc',
    '-mem-path', '/hugepages',
    '-cpu', 'host,kvm=off,hv_relaxed,hv_spinlocks=0x1fff,hv_time,hv_vendor_id=12CHARID',
    '-smp', '12,sockets=1,cores=6,threads=2',
    '-drive', 'file=/home/user/win-qemu.img,id=disk,format=raw,if=none',
    '-device', 'nec-usb-xhci',
    '-device', 'usb-ehci,id=ehci',
    '-device', 'usb-mouse',
    '-device', 'ide-hd,drive=disk',
    '-device', 'secondary-vga',
    '-device', 'vfio-pci,host=01:00.0,addr=09.0,multifunction=on',
    '-device', 'vfio-pci,host=01:00.1',
    '-rtc', 'base=localtime',
    '-soundhw', 'ac97',
    '-vga', 'none',
]

if __name__ == '__main__':
    usb_devices = subprocess.check_output(['lsusb'])

    usb_args = []
    for l in usb_devices.split(b'\n'):
        # PS4 controller
        if b'054c:09cc' in l:
            pts = l.split(b' ')
            usb_args.extend(['-device', 'usb-host,hostbus={},hostaddr={}'.format(int(pts[1]), int(pts[3][:-1]))])
        # iPhone 8+
        if b'05ac:12a8' in l:
            pts = l.split(b' ')
            usb_args.extend(['-device', 'usb-host,bus=ehci.0,hostbus={},hostaddr={}'.format(int(pts[1]), int(pts[3][:-1]))])

    if usb_args:
        ARGS.extend(['-usb'])
        ARGS.extend(usb_args)

    os.putenv('QEMU_AUDIO_DRV', 'alsa')
    print(' '.join(ARGS))
    subprocess.run(ARGS)
